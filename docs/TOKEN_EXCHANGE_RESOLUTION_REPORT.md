# Technical Report: Resolving Shopify Token Exchange Authentication Issues in Thunder Text Application

## Executive Summary

The Thunder Text application experienced critical authentication failures preventing product data retrieval in the embedded Shopify app environment. The root cause was improper implementation of Shopify's Token Exchange API, specifically requesting online access tokens instead of offline tokens, combined with malformed GraphQL queries. This report details the authentication architecture, identifies the failure points, and documents the implemented solutions.

## Background

Thunder Text is an embedded Shopify application that enhances product descriptions using AI. The application operates within Shopify's admin interface and requires authenticated access to merchant product data through the Admin GraphQL API.

### Initial Problem Manifestation
- Products list page displayed "0 products" despite the store containing 11 products
- Individual product detail fetching returned 404 "Product not found" errors
- Console showed Token Exchange failures and authentication errors
- The app had been properly installed through Shopify Partners Dashboard with environment variables configured in Vercel

## Technical Architecture

### Authentication Flow Overview

Embedded Shopify apps use a two-token authentication system:

1. **Session Tokens (JWT)**: Short-lived tokens (60-second expiry) generated by Shopify App Bridge
2. **Access Tokens**: Long-lived tokens obtained via Token Exchange API for API access

```
[App Bridge] → Session Token → [Token Exchange] → Access Token → [Admin API]
```

### Token Types Distinction

**Online Access Tokens:**
- Tied to individual user sessions
- Expire when the user logs out
- Limited to the user's permissions
- Suitable for user-specific actions

**Offline Access Tokens:**
- Persist indefinitely until explicitly revoked
- Not tied to user sessions
- Full access to authorized scopes
- Required for background jobs and persistent data access

## Root Cause Analysis

### Issue 1: Incorrect Token Type Request

**Location**: `/src/lib/shopify-auth.ts:57`

**Problem Code:**
```typescript
const requestBody = {
  client_id: process.env.SHOPIFY_API_KEY,
  client_secret: process.env.SHOPIFY_API_SECRET,
  subject_token: sessionToken,
  subject_token_type: 'urn:ietf:params:oauth:token-type:id_token',
  grant_type: 'urn:ietf:params:oauth:grant-type:token-exchange',
  requested_token_type: 'urn:shopify:params:oauth:token-type:online-access-token',  // ❌ WRONG
}
```

**Impact**: Online tokens would expire with user sessions, causing intermittent authentication failures and inability to fetch products consistently.

### Issue 2: GraphQL Query Schema Mismatch

**Location**: `/src/lib/shopify/product-prepopulation.ts`

**Problem Code:**
```graphql
variants(first: 100) {
  edges {
    node {
      id
      title
      price
      sku
      weight  // ❌ Field doesn't exist in ProductVariant type
    }
  }
}
```

**Impact**: GraphQL queries failed with field validation errors, preventing any product data retrieval.

### Issue 3: Response Structure Handling

**Location**: Multiple files

**Problem Code:**
```typescript
// Incorrect assumption about response structure
if (!response || !response.product) {  // ❌ Wrong path
  return null
}
```

**Actual Structure:**
```typescript
// Correct structure from shopifyGraphQL helper
response = {
  data: {
    product: { /* product data */ }
  }
}
```

## Implemented Solutions

### Solution 1: Offline Token Implementation

**File**: `/src/lib/shopify-auth.ts`

```typescript
const requestBody = {
  client_id: process.env.SHOPIFY_API_KEY,
  client_secret: process.env.SHOPIFY_API_SECRET,
  subject_token: sessionToken,
  subject_token_type: 'urn:ietf:params:oauth:token-type:id_token',
  grant_type: 'urn:ietf:params:oauth:grant-type:token-exchange',
  requested_token_type: 'urn:shopify:params:oauth:token-type:offline-access-token',  // ✅ CORRECT
}
```

**Rationale**: Offline tokens provide persistent access required for fetching product data independent of user sessions.

### Solution 2: GraphQL Schema Compliance

**File**: `/src/app/api/shopify/product-prepopulation/route.ts`

```graphql
variants(first: 100) {
  edges {
    node {
      id
      title
      price
      sku
      // weight removed - field doesn't exist
    }
  }
}
```

**Rationale**: Aligned queries with actual Shopify Admin API GraphQL schema (2025-01 version).

### Solution 3: Proper Response Handling

**File**: `/src/lib/shopify/product-prepopulation.ts`

```typescript
const response = await shopifyGraphQL(query, { id: formattedProductId }, shop, sessionToken)

if (!response?.data?.product) {  // ✅ Correct path
  console.error('❌ No product found with ID:', formattedProductId)
  return null
}

return response.data.product  // ✅ Access correct nested structure
```

### Solution 4: Authentication Flow Integration

**File**: `/src/app/products/page.tsx`

```typescript
// Use authenticatedFetch from ShopifyAuthProvider
let response
if (authenticatedFetch) {
  response = await authenticatedFetch(`/api/shopify/products?${params}`)
} else {
  // Fallback with manual token inclusion
  const headers: HeadersInit = {
    'Content-Type': 'application/json',
  }
  if (sessionToken) {
    headers['Authorization'] = `Bearer ${sessionToken}`
  }
  response = await fetch(`/api/shopify/products?${params}`, { headers })
}
```

## Implementation Timeline

1. **Diagnosis Phase**: Identified Token Exchange failures through console logs
2. **Research Phase**: Consulted Shopify MCP documentation for Token Exchange specifications
3. **Fix Implementation**:
   - Changed token type from online to offline
   - Updated token storage to reflect offline type
   - Fixed GraphQL query schema issues
   - Corrected response structure handling
4. **Testing & Verification**: Confirmed successful product retrieval

## Verification Results

### Before Fix:
- Products API: Returned empty array `[]`
- Product Detail API: 404 "Product not found"
- Console: Multiple Token Exchange failures

### After Fix:
- Products API: Successfully returns 11 products
- Product Detail API: Returns complete product data with images, variants, and metadata
- Console: Clean execution with successful authentication

## Key Learnings

### 1. Token Type Selection is Critical
Online vs offline token selection directly impacts data access persistence. For embedded apps requiring consistent data access, offline tokens are essential.

### 2. GraphQL Schema Validation
Always validate GraphQL queries against the current API schema version. Field availability can change between API versions.

### 3. Response Structure Consistency
Maintain consistent response structure handling across helper functions and direct API calls.

### 4. Authentication Debugging Strategy
- Start with token type verification
- Validate API scopes (`read_products` required)
- Test with simplified queries before complex ones
- Use debug endpoints to isolate issues

## Best Practices for Future Development

1. **Always use offline tokens** for embedded Shopify apps unless specifically requiring user-session-bound access
2. **Validate GraphQL queries** against schema documentation before implementation
3. **Implement comprehensive error logging** that captures full error responses for debugging
4. **Create debug endpoints** during development for isolated testing
5. **Document authentication flows** explicitly in code comments
6. **Test with actual Shopify stores** rather than mock data to catch schema mismatches early

## Conclusion

The authentication issues stemmed from a fundamental misunderstanding of Shopify's token types and their appropriate use cases. By switching to offline tokens and fixing the GraphQL schema compliance issues, the application now successfully retrieves and displays product data. This solution ensures persistent, reliable access to merchant data regardless of user session state, which is critical for the Thunder Text application's core functionality of enhancing product descriptions.

The implemented fixes follow Shopify's official Token Exchange documentation and best practices for embedded app development, ensuring long-term stability and compliance with Shopify's security requirements.

## Appendix: File Changes Summary

### Modified Files:
1. `/src/lib/shopify-auth.ts` - Changed token type to offline
2. `/src/app/api/shopify/products/route.ts` - Implemented proper Token Exchange
3. `/src/app/products/page.tsx` - Added session token to API calls
4. `/src/app/api/shopify/product-prepopulation/route.ts` - Fixed GraphQL query
5. `/src/lib/shopify/product-prepopulation.ts` - Corrected response handling
6. `/src/lib/shopify/token-manager.ts` - Updated for offline token storage

### Key Commits:
- "Fix Token Exchange to use offline access tokens"
- "Fix products API route structure"
- "Update token manager for offline tokens"
- "Fix product-prepopulation to use shopifyGraphQL helper"
- "Remove weight field from product variant query"

---

*Document prepared: September 29, 2025*
*Author: Senior Engineering Team*
*Project: Thunder Text - Shopify App Development*